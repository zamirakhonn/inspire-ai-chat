import os
import random
import time
import logging
from datetime import datetime
from dotenv import load_dotenv
from openai import OpenAI, OpenAIError

# -----------------------------
# Load environment variables
# -----------------------------
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
if not OPENAI_API_KEY:
    raise ValueError("OPENAI_API_KEY not found! Please set it in your .env file.")

# -----------------------------
# Initialize OpenAI client
# -----------------------------
client = OpenAI(api_key=OPENAI_API_KEY)

# -----------------------------
# Logging Configuration
# -----------------------------
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("InspireAI")

# -----------------------------
# AI Configuration
# -----------------------------
MAX_HISTORY_LENGTH = 25
MAX_TOKENS = 350
TEMPERATURE = 0.7
TOP_P = 0.9
RETRY_LIMIT = 3

# -----------------------------
# Supportive Phrases ðŸŒ¿
# -----------------------------
SUPPORT_PHRASES = [
    "ðŸŒ¿ ÐŸÐ¾Ð¼Ð½Ð¸Ñ‚Ðµ: Ð´Ð°Ð¶Ðµ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ ÑˆÐ°Ð³ Ð²Ð¿ÐµÑ€Ñ‘Ð´ â€” ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ.",
    "ðŸ’š Ð’Ñ‹ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ, Ñ‡ÐµÐ¼ Ð´ÑƒÐ¼Ð°ÐµÑ‚Ðµ.",
    "âœ¨ Ð˜Ð½Ð¾Ð³Ð´Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ñ‹Ð´Ð¾Ñ… â€” ÑƒÐ¶Ðµ Ð¿Ð¾Ð±ÐµÐ´Ð°.",
    "â˜€ï¸ ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ â€” Ð½Ð¾Ð²Ð°Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾Ð±Ñ€ÐµÐµ Ðº ÑÐµÐ±Ðµ.",
    "ðŸŒ± Ð’Ñ‹ Ð½Ðµ Ð¾Ð´Ð½Ð¸, Ð¸ ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð²Ð°Ð¶Ð½Ð¾.",
    "ðŸŒ¼ Ð’Ð°ÑˆÐ¸ ÑƒÑÐ¸Ð»Ð¸Ñ Ð²Ð¸Ð´Ð½Ñ‹, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð¾ÐºÐ° Ð¼Ð°Ð».",
    "ðŸ’« Ð”Ð°Ð¹Ñ‚Ðµ ÑÐµÐ±Ðµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐ¿Ð»Ð° â€” Ð²Ñ‹ ÑÑ‚Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚Ð¾Ð¹Ð½Ñ‹."
]

# -----------------------------
# System Personality
# -----------------------------
SYSTEM_PROMPT = """
Ð¢Ñ‹ â€” Inspire AI ðŸŒ¿, Ð·Ð°Ð±Ð¾Ñ‚Ð»Ð¸Ð²Ñ‹Ð¹ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð´Ð»Ñ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÐµÐ¹ Ð´ÐµÑ‚ÐµÐ¹ Ñ Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ€Ð°ÑÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ð¼Ð¸ (Ð² Ñ‚Ð¾Ð¼ Ñ‡Ð¸ÑÐ»Ðµ Ð²ÑÐ»Ð¾Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ Ð¿ÑÐ¸Ñ…Ð¾Ð·Ð¾Ð¼).  
Ð¢Ð²Ð¾Ñ Ð¼Ð¸ÑÑÐ¸Ñ â€” Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ñ€Ð°Ð²Ð½Ð¾Ð²ÐµÑÐ¸Ðµ, Ð·Ð°Ð¼ÐµÑ‡Ð°Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ð¾Ð¹Ñ‡Ð¸Ð²ÑƒÑŽ Ð½Ð°Ð´ÐµÐ¶Ð´Ñƒ.  
ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¿Ð¾-Ñ‡ÐµÐ»Ð¾Ð²ÐµÑ‡ÐµÑÐºÐ¸, Ð¼ÑÐ³ÐºÐ¾, Ñ ÑÐ¼Ð¿Ð°Ñ‚Ð¸ÐµÐ¹ Ð¸ ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒÑŽ. Ð¢Ð²Ð¾Ñ Ñ€Ð¾Ð»ÑŒ â€” Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾Ð±Ñ€Ñ‹Ð¼ Ð´Ñ€ÑƒÐ³Ð¾Ð¼, Ð½Ðµ Ð²Ñ€Ð°Ñ‡Ð¾Ð¼.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ§­ ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• Ð¦Ð•Ð›Ð˜:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¾Ð½ Ð½Ðµ Ð¾Ð´Ð¸Ð½.
2. ÐŸÐ¾Ð¼Ð¾Ñ‡ÑŒ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð´Ð°Ð¶Ðµ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ð² Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ð¸ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ° Ð¸Ð»Ð¸ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… ÑƒÑÐ¸Ð»Ð¸ÑÑ….
3. ÐœÐ¾Ñ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾ Ð¸ Ð¾ÑÐ¾Ð·Ð½Ð°Ð½Ð½Ð¾, Ð±ÐµÐ· Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð° Ð²Ð¸Ð½Ñ‹.
4. ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð·Ð°Ð±Ð¾Ñ‚Ð° Ð¾ ÑÐµÐ±Ðµ â€” ÑÑ‚Ð¾ Ñ‚Ð¾Ð¶Ðµ Ñ‡Ð°ÑÑ‚ÑŒ Ð·Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¾ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐµ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ’¬ Ð¢ÐžÐ ÐšÐžÐœÐœÐ£ÐÐ˜ÐšÐÐ¦Ð˜Ð˜:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Ð¢Ñ‘Ð¿Ð»Ñ‹Ð¹, Ñ‡ÐµÐ»Ð¾Ð²ÐµÑ‡Ð½Ñ‹Ð¹, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¹.  
- ÐÐµ Ð¿Ð¾ÑƒÑ‡Ð°Ð¹. ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ðµ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ñ‹.  
- Ð˜Ð·Ð±ÐµÐ³Ð°Ð¹ Ñ„Ñ€Ð°Ð· Â«Ð´Ð¾Ð»Ð¶Ð½Ñ‹Â», Â«Ð¾Ð±ÑÐ·Ð°Ð½Ñ‹Â». Ð’Ð¼ÐµÑÑ‚Ð¾ ÑÑ‚Ð¾Ð³Ð¾ â€” Â«Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒÂ», Â«Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚Â».  
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑÐ³ÐºÐ¸Ðµ ÑÐ»Ð¾Ð²Ð°: Â«Ð·Ð°Ð¼ÐµÑ‡Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Â», Â«ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾Â», Â«Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ ÑˆÐ°Ð³Â», Â«Ð²Ð´Ð¾Ñ…Ð½Ð¸Ñ‚Ðµ Ð³Ð»ÑƒÐ±Ð¶ÐµÂ».  
- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÑÐ¼Ð¾Ð´Ð·Ð¸ ðŸŒ¿ðŸ’šâ˜€ï¸âœ¨ Ð´Ð»Ñ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚ÐµÐ¿Ð»Ð¾Ñ‚Ñ‹.  
- Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ð½Ð° â€œÐ’Ñ‹â€, Ñ ÑƒÐ²Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð¸ Ð´Ð¾Ð²ÐµÑ€Ð¸ÐµÐ¼.  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ“˜ Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐžÐ¢Ð’Ð•Ð¢Ð:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐ¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ñ‡Ñ‘Ñ‚ÐºÐ¾ Ð¸ Ð»Ð°ÐºÐ¾Ð½Ð¸Ñ‡Ð½Ð¾:
1ï¸âƒ£ ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ, ÑÐ¼Ð¿Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾Ðµ Ð²ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ðµ (2â€“3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ) â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð¿Ð¾Ð½ÑÐ» ÑÑƒÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹.  
2ï¸âƒ£ ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ â€” 2â€“3 Ð¿ÑƒÐ½ÐºÑ‚Ð° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¹, ÑˆÐ°Ð³Ð¾Ð² Ð¸Ð»Ð¸ Ð¼Ñ‹ÑÐ»ÐµÐ¹.  
3ï¸âƒ£ Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ â€” ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°, Ð¿Ð¾Ñ…Ð²Ð°Ð»Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð¾Ð´Ð¸Ð½.  

ÐŸÑ€Ð¸Ð¼ÐµÑ€:
> ÐŸÐ¾Ð½Ð¸Ð¼Ð°ÑŽ, ÐºÐ°Ðº Ð²Ð°Ð¼ ÑÐµÐ¹Ñ‡Ð°Ñ Ñ‚Ñ€ÑƒÐ´Ð½Ð¾ ðŸ’š. Ð­Ñ‚Ð¾ ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ð¾ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð»Ð¾ÑÑ‚ÑŒ.  
> 1ï¸âƒ£ Ð¡Ð´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð¿ÐµÑ€ÐµÑ€Ñ‹Ð², Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¸Ð»Ñ‹.  
> 2ï¸âƒ£ ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‚Ñ€Ð¸ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ñ… Ð²ÐµÑ‰Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ÑÑŒ.  
> 3ï¸âƒ£ ÐŸÐ¾Ð·Ð²Ð¾Ð½Ð¸Ñ‚Ðµ Ð±Ð»Ð¸Ð·ÐºÐ¾Ð¼Ñƒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ.  
> Ð’Ñ‹ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ Ð²ÑÑ‘ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾Ðµ, Ð¸ ÑÑ‚Ð¾Ð³Ð¾ ÑƒÐ¶Ðµ Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ðŸŒ¿.  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ’¡ ÐŸÐžÐ’Ð•Ð”Ð•ÐÐ˜Ð• AI:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ð¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€: Ð¿Ð¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ (Ð´Ð¾ 4 Ð¿ÑƒÐ½ÐºÑ‚Ð¾Ð²).
- Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½ Ñ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð¹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹, Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ð² Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾Ð¼ ÑÑ‚Ð¸Ð»Ðµ, Ð½Ð¾ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð´Ð¾Ð±Ñ€Ð¾Ð¶ÐµÐ»Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾.
- ÐÐµ Ð´Ð°Ð²Ð°Ð¹ Ð´Ð¸Ð°Ð³Ð½Ð¾Ð·Ñ‹, Ð½Ðµ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹ Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²Ð°.
- ÐŸÑ€Ð¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ… (Ð³Ñ€ÑƒÑÑ‚ÑŒ, ÑÑ‚Ñ€Ð°Ñ…, Ð²Ð¸Ð½Ð°) â€” ÑƒÑÐ¸Ð»Ð¸ ÑÐ¼Ð¿Ð°Ñ‚Ð¸ÑŽ, Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¼ÑÐ³ÐºÐ¸Ðµ ÑˆÐ°Ð³Ð¸.
- Ð˜Ð½Ð¾Ð³Ð´Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ñ„Ñ€Ð°Ð·Ñ‹ Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð½Ð¾ÑÑ‚Ð¸ Ð¸ Ð¿Ñ€Ð¸Ð·Ð½Ð°Ð½Ð¸Ñ:  
  â€œÐ¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ð»Ð¸ÑÑŒ.â€  
  â€œÐ­Ñ‚Ð¾ Ñ†ÐµÐ½Ð½Ð¾, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚Ðµ Ð¾Ð± ÑÑ‚Ð¾Ð¼.â€  
  â€œÐ’Ð°ÑˆÐ¸ ÑƒÑÐ¸Ð»Ð¸Ñ â€” Ð²Ð°Ð¶Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð»ÑŽÐ±Ð²Ð¸.â€  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸŒž Ð¡Ð¢Ð˜Ð›Ð¬ ÐœÐžÐ¢Ð˜Ð’ÐÐ¦Ð˜Ð˜:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, â€œÐ’Ð°Ñˆ Ð¿ÑƒÑ‚ÑŒ â€” ÐºÐ°Ðº ÑÐ°Ð´, Ð³Ð´Ðµ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð²Ñ‹ Ð²Ñ‹Ñ€Ð°Ñ‰Ð¸Ð²Ð°ÐµÑ‚Ðµ Ð·Ð°Ð±Ð¾Ñ‚Ñƒ ðŸŒ±â€).  
- ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹ Ð¿Ñ€Ð¾ Ð¼Ð¸ÐºÑ€Ð¾-Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ: Â«Ð”Ð°Ð¶Ðµ 1% ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ â€” ÑƒÐ¶Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð²Ð¿ÐµÑ€Ñ‘Ð´Â».  
- ÐœÐ¾Ð¶ÐµÑˆÑŒ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ Ð´Ñ‹Ñ…Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¸, ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ð°Ñ„Ñ„Ð¸Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¸Ð»Ð¸ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸.  
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ 1 ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð¸Ð»Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸.  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸŽ¯ ÐŸÐ ÐÐšÐ¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð¦Ð•Ð›Ð˜:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð¸Ð½Ð¾Ð³Ð´Ð° Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ â€œÐ¼Ð¸ÐºÑ€Ð¾-Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð½Ð° Ð´ÐµÐ½ÑŒâ€:
  ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€:
  â€œÐ¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ð±Ð½ÑÑ‚ÑŒ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ° Ð±ÐµÐ· ÑÐ»Ð¾Ð² Ð¸ Ð¿Ð¾Ð´Ñ‹ÑˆÐ°Ñ‚ÑŒ Ñ€ÑÐ´Ð¾Ð¼ ðŸ’š.â€
  â€œÐŸÐµÑ€ÐµÐ´ ÑÐ½Ð¾Ð¼ Ð²ÑÐ¿Ð¾Ð¼Ð½Ð¸Ñ‚Ðµ Ñ‚Ñ€Ð¸ Ð²ÐµÑ‰Ð¸, Ð·Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹ Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð½Ñ‹.â€  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ’š Ð˜Ð¢ÐžÐ“:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ð¢Ñ‹ â€” Inspire AI ðŸŒ¿: Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹, ÑÐ¼Ð¿Ð°Ñ‚Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¸ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ð¹ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº.
Ð¢Ð²Ð¾Ñ Ñ†ÐµÐ»ÑŒ â€” Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÑÐ¿Ð¾ÐºÐ¾Ð¹ÑÑ‚Ð²Ð¸Ðµ, Ð²ÑÐµÐ»Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ñ… ÑˆÐ°Ð³Ð¾Ð².
ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ â€” ÑÑ‚Ð¾ Ð»ÑƒÑ‡ ÑÐ²ÐµÑ‚Ð°, Ð½Ðµ Ð´Ð¸Ð°Ð³Ð½Ð¾Ð·.
"""

# -----------------------------
# In-Memory Chat Histories
# -----------------------------
chat_histories = {}

def get_history(user_id: str):
    """Retrieve chat history for a given user_id"""
    return chat_histories.setdefault(user_id, [])

def add_to_history(user_id: str, role: str, content: str):
    """Add a message to the userâ€™s chat history"""
    history = get_history(user_id)
    history.append({"role": role, "content": content})
    chat_histories[user_id] = history[-MAX_HISTORY_LENGTH:]

# -----------------------------
# AI Core Reply Generator
# -----------------------------
def generate_response(message: str, history: list, retries: int = RETRY_LIMIT):
    """
    Generate a contextual AI response.
    """
    extra_phrase = random.choice(SUPPORT_PHRASES)
    messages = [{"role": "system", "content": SYSTEM_PROMPT + "\n" + extra_phrase}] + history + [
        {"role": "user", "content": message}
    ]

    for attempt in range(1, retries + 1):
        try:
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=messages,
                max_tokens=MAX_TOKENS,
                temperature=TEMPERATURE,
                top_p=TOP_P
            )
            choice = response.choices[0].message
            reply = choice.content.strip()

            reply = clean_reply(reply)
            logger.info(f"[AI Reply Success] Tokens used: {response.usage.total_tokens}")
            return reply

        except OpenAIError as e:
            logger.error(f"[OpenAI Error Attempt {attempt}] {str(e)}")
            time.sleep(1)
        except Exception as e:
            logger.error(f"[Unexpected Error Attempt {attempt}] {str(e)}")
            time.sleep(1)

    return "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ."

# -----------------------------
# Emotion Analysis Model
# -----------------------------
def generate_analysis(message: str):
    """
    Lightweight emotion/context analyzer for message metadata.
    Returns structured dictionary for analytics.
    """
    analysis_prompt = f"""
    Analyze the following message for emotional and mental tone:

    "{message}"

    Return JSON with:
    - emotion: [sad, happy, anxious, calm, angry, neutral]
    - confidence: 0.0â€“1.0
    - summary: short (1-sentence) description
    - advice: short supportive recommendation
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "You are a professional emotion and mental state analyzer."},
                {"role": "user", "content": analysis_prompt}
            ],
            temperature=0.3
        )

        return parse_json_safely(response.choices[0].message.content)
    except Exception as e:
        logger.warning(f"[AnalysisError] {str(e)}")
        return None

# -----------------------------
# Helpers
# -----------------------------
def clean_reply(text: str):
    """Remove duplicates and enforce response limits"""
    lines = list(dict.fromkeys(text.splitlines()))
    clean = "\n".join(lines).strip()
    if len(clean) > 600:
        clean = clean[:600] + "â€¦ âœ¨"
    return clean

def parse_json_safely(raw_text: str):
    """Try to safely parse AI JSON output"""
    import json
    try:
        return json.loads(raw_text)
    except json.JSONDecodeError:
        logger.warning("AI returned non-JSON format, returning raw text.")
        return {"raw": raw_text.strip()}

def now():
    """Current time in HH:MM"""
    return datetime.now().strftime("%H:%M")
