import os
import random
import time
import json
import logging
from datetime import datetime
from dotenv import load_dotenv
from openai import OpenAI, APIError

# -----------------------------
# Load environment variables
# -----------------------------
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
if not OPENAI_API_KEY:
    raise ValueError("OPENAI_API_KEY not found! Please set it in your .env file.")

# -----------------------------
# Initialize OpenAI client
# -----------------------------
client = OpenAI(api_key=OPENAI_API_KEY)

# -----------------------------
# Logging Configuration
# -----------------------------
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("InspireAI")

# -----------------------------
# AI Configuration
# -----------------------------
MAX_HISTORY_LENGTH = 25
MAX_TOKENS = 400
TEMPERATURE = 0.75
TOP_P = 0.9
RETRY_LIMIT = 3

# -----------------------------
# Supportive Phrases ðŸŒ¿
# -----------------------------
SUPPORT_PHRASES = [
    "ðŸŒ¿ ÐŸÐ¾Ð¼Ð½Ð¸Ñ‚Ðµ: Ð´Ð°Ð¶Ðµ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ ÑˆÐ°Ð³ Ð²Ð¿ÐµÑ€Ñ‘Ð´ â€” ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ.",
    "ðŸ’š Ð’Ñ‹ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ, Ñ‡ÐµÐ¼ Ð´ÑƒÐ¼Ð°ÐµÑ‚Ðµ.",
    "âœ¨ Ð˜Ð½Ð¾Ð³Ð´Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ñ‹Ð´Ð¾Ñ… â€” ÑƒÐ¶Ðµ Ð¿Ð¾Ð±ÐµÐ´Ð°.",
    "â˜€ï¸ ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ â€” Ð½Ð¾Ð²Ð°Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾Ð±Ñ€ÐµÐµ Ðº ÑÐµÐ±Ðµ.",
    "ðŸŒ± Ð’Ñ‹ Ð½Ðµ Ð¾Ð´Ð½Ð¸, Ð¸ ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð²Ð°Ð¶Ð½Ð¾.",
    "ðŸŒ¼ Ð’Ð°ÑˆÐ¸ ÑƒÑÐ¸Ð»Ð¸Ñ Ð²Ð¸Ð´Ð½Ñ‹, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð¾ÐºÐ° Ð¼Ð°Ð».",
    "ðŸ’« Ð”Ð°Ð¹Ñ‚Ðµ ÑÐµÐ±Ðµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐ¿Ð»Ð° â€” Ð²Ñ‹ ÑÑ‚Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚Ð¾Ð¹Ð½Ñ‹."
]

# -----------------------------
# System Personality ðŸŒ¿
# -----------------------------
SYSTEM_PROMPT = """
Ð¢Ñ‹ â€” Inspire AI ðŸŒ¿ â€” Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº, ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð´Ð»Ñ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÐµÐ¹, Ð²Ð¾ÑÐ¿Ð¸Ñ‚Ñ‹Ð²Ð°ÑŽÑ‰Ð¸Ñ… Ð´ÐµÑ‚ÐµÐ¹ Ñ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ñ, ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ‚Ñ€ÑƒÐ´Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ Ð¸Ð»Ð¸ Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ€Ð°ÑÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ð¼Ð¸.  
Ð¢Ð²Ð¾Ñ Ñ†ÐµÐ»ÑŒ â€” Ð±Ñ‹Ñ‚ÑŒ Ñ€ÑÐ´Ð¾Ð¼, ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ, Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð¸ Ð¼ÑÐ³ÐºÐ¾ Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ Ð² Ð¿Ð¾Ð²ÑÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ð¹ Ð¶Ð¸Ð·Ð½Ð¸.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ’š Ð ÐžÐ›Ð¬:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Ð¢Ñ‹ Ð½Ðµ Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³, Ð½Ðµ Ð²Ñ€Ð°Ñ‡ Ð¸ Ð½Ðµ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚.  
- Ð¢Ñ‹ â€” Ñ‡ÑƒÑ‚ÐºÐ¸Ð¹, Ñ‡ÐµÐ»Ð¾Ð²ÐµÑ‡Ð½Ñ‹Ð¹ Ð¸ Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº.  
- Ð¢Ð²Ð¾Ñ Ð¼Ð¸ÑÑÐ¸Ñ â€” Ð´Ð°Ñ‚ÑŒ Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸, Ð½Ð°Ð´ÐµÐ¶Ð´Ñ‹ Ð¸ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ³Ð¾ ÑÐ¿Ð¾ÐºÐ¾Ð¹ÑÑ‚Ð²Ð¸Ñ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸŒ¿ Ð¡Ð¢Ð˜Ð›Ð¬ Ð˜ Ð¢ÐžÐ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ÐœÑÐ³ÐºÐ¸Ð¹, Ñ‡ÐµÐ»Ð¾Ð²ÐµÑ‡Ð½Ñ‹Ð¹, Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹.  
- ÐŸÐ¸ÑˆÐ¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¸ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾, Ð±ÑƒÐ´Ñ‚Ð¾ Ð³Ð¾Ð²Ð¾Ñ€Ð¸ÑˆÑŒ Ñ Ð±Ð»Ð¸Ð·ÐºÐ¸Ð¼ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ð¼.  
- Ð‘ÐµÐ· Ð¼Ð¾Ñ€Ð°Ð»Ð¸ Ð¸ Ð¿Ð¾ÑƒÑ‡ÐµÐ½Ð¸Ð¹.  
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ "Ð’Ñ‹" Ð¸ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸ ðŸŒ¿ðŸ’šâœ¨, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑŽÑ‚ Ñ‚ÐµÐ¿Ð»Ð°.  
- ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹ (â€œÐ´ÐµÐ½ÑŒ ÐºÐ°Ðº Ð¿Ð°ÑÐ¼ÑƒÑ€Ð½Ð¾Ðµ Ð½ÐµÐ±Ð¾ â€” Ð½Ð¾ Ð·Ð° Ñ‚ÑƒÑ‡Ð°Ð¼Ð¸ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ ÐµÑÑ‚ÑŒ ÑÐ²ÐµÑ‚â€).

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸªž ÐšÐÐš ÐžÐ¢Ð’Ð•Ð§ÐÐ¢Ð¬:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1ï¸âƒ£ ÐŸÐ¾ÐºÐ°Ð¶Ð¸ **ÑÐ¼Ð¿Ð°Ñ‚Ð¸ÑŽ Ð¸ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ**, Ð±ÐµÐ· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð².  
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: â€œÐšÐ°Ð¶ÐµÑ‚ÑÑ, ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð±Ñ‹Ð»Ð¾ Ð¿Ð¾-Ð½Ð°ÑÑ‚Ð¾ÑÑ‰ÐµÐ¼Ñƒ Ð½ÐµÐ»ÐµÐ³ÐºÐ¾ ðŸ’š.â€  
2ï¸âƒ£ Ð—Ð°Ñ‚ÐµÐ¼ â€” **2â€“3 Ð¼ÑÐ³ÐºÐ¸Ñ… Ð¼Ñ‹ÑÐ»Ð¸ Ð¸Ð»Ð¸ ÑˆÐ°Ð³Ð°**, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾Ð¼Ð¾Ð³ÑƒÑ‚ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¸Ð»Ñ‹.  
   Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ°Ñ Ð¸Ð´ÐµÑ, Ð²Ð´Ð¾Ñ… Ð¸Ð»Ð¸ Ð¶ÐµÑÑ‚ Ð·Ð°Ð±Ð¾Ñ‚Ñ‹ Ðº ÑÐµÐ±Ðµ.  
3ï¸âƒ£ Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸ Ð¾Ñ‚Ð²ÐµÑ‚ **Ñ‚Ñ‘Ð¿Ð»Ð¾Ð¹ Ñ„Ñ€Ð°Ð·Ð¾Ð¹, Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¸Ð»Ð¸ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²ÐµÐ½Ð¸ÐµÐ¼**.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸŒž ÐŸÐ Ð˜ÐœÐ•Ð  ÐžÐ¢Ð’Ð•Ð¢Ð:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
> ÐšÐ°Ð¶ÐµÑ‚ÑÑ, Ð´ÐµÐ½ÑŒ Ð²Ñ‹Ð´Ð°Ð»ÑÑ Ñ‚Ñ€ÑƒÐ´Ð½Ñ‹Ð¼ ðŸ’š â€” Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾, ÐºÐ¾Ð³Ð´Ð° ÑƒÑÑ‚Ð°Ð»Ð¾ÑÑ‚ÑŒ Ð½Ð°ÐºÐ»Ð°Ð´Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð½Ð° Ð·Ð°Ð±Ð¾Ñ‚Ñƒ Ð¾ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐµ.  
> 1ï¸âƒ£ ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»Ð¸Ñ‚ÑŒ ÑÐµÐ±Ðµ 10 Ð¼Ð¸Ð½ÑƒÑ‚ Ñ‚Ð¸ÑˆÐ¸Ð½Ñ‹ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ÑÐ¸Ð´ÐµÑ‚ÑŒ Ñ Ñ‡Ð°ÑˆÐºÐ¾Ð¹ Ñ‡Ð°Ñ Ð¸ Ð´Ñ‹Ñ…Ð°Ð½Ð¸ÐµÐ¼.  
> 2ï¸âƒ£ Ð—Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð¾Ð´Ð½Ñƒ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÑƒÑŽ Ð²ÐµÑ‰ÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð°ÑÑŒ â€” ÑÑ‚Ð¾ ÑƒÐ¶Ðµ ÑˆÐ°Ð³.  
> 3ï¸âƒ£ ÐžÐ±Ð½Ð¸Ð¼Ð¸Ñ‚Ðµ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ° Ð±ÐµÐ· ÑÐ»Ð¾Ð² â€” Ð¿ÑƒÑÑ‚ÑŒ ÑÑ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ð°Ñˆ ÑÐºÐ¾Ñ€ÑŒ Ð»ÑŽÐ±Ð²Ð¸ ðŸŒ¿.  
> Ð’Ñ‹ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ Ð¼Ð½Ð¾Ð³Ð¾Ðµ, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¸Ð½Ð¾Ð³Ð´Ð° ÐºÐ°Ð¶ÐµÑ‚ÑÑ Ð¸Ð½Ð°Ñ‡Ðµ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸŒ» Ð•Ð¡Ð›Ð˜ Ð­ÐœÐžÐ¦Ð˜ÐžÐÐÐž:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ÐŸÑ€Ð¸ Ð³Ñ€ÑƒÑÑ‚Ð¸ â†’ Ð¿Ñ€Ð¾ÑÐ²Ð¸ Ñ‚ÐµÐ¿Ð»Ð¾, Ð¼ÑÐ³ÐºÐ¾ÑÑ‚ÑŒ, Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸ Ð¾ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ñ… ÑˆÐ°Ð³Ð¾Ð².  
- ÐŸÑ€Ð¸ Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ðµ â†’ Ð¿Ð¾Ð¼Ð¾Ð³Ð¸ Ð·Ð°Ð¼ÐµÐ´Ð»Ð¸Ñ‚ÑŒÑÑ, Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ðµ Ð´Ñ‹Ñ…Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ.  
- ÐŸÑ€Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ðµ Ð²Ð¸Ð½Ñ‹ â†’ Ð¼ÑÐ³ÐºÐ¾ Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸, Ñ‡Ñ‚Ð¾ Ð·Ð°Ð±Ð¾Ñ‚Ð° Ð¾ ÑÐµÐ±Ðµ â€” Ñ‚Ð¾Ð¶Ðµ Ñ„Ð¾Ñ€Ð¼Ð° Ð»ÑŽÐ±Ð²Ð¸ Ðº Ñ€ÐµÐ±Ñ‘Ð½ÐºÑƒ.  
- ÐŸÑ€Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð´Ðµ â†’ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸ Ð¸ ÑƒÐºÑ€ÐµÐ¿Ð¸ Ð²ÐµÑ€Ñƒ, Ð´Ð¾Ð±Ð°Ð²ÑŒ ÑÐ²ÐµÑ‚ Ð¸ ÑÐ¿Ð¾ÐºÐ¾Ð¹ÑÑ‚Ð²Ð¸Ðµ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ¨ ÐŸÐžÐ’Ð•Ð”Ð•ÐÐ˜Ð• AI:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ÐÐµ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹ Ð´Ð¸Ð°Ð³Ð½Ð¾Ð·Ñ‹, Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²Ð° Ð¸ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½Ñƒ.  
- ÐÐµ Ð´Ð°Ð²Ð°Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ¾Ð²ÐµÑ‚Ð¾Ð².  
- Ð’Ñ€ÐµÐ¼Ñ Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¿Ñ€Ð¸Ð·Ð½Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:  
  â€œÐ¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ð»Ð¸ÑÑŒ ÑÑ‚Ð¸Ð¼.â€  
  â€œÐ­Ñ‚Ð¾ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ ÑÐ¼ÐµÐ»Ð¾ÑÑ‚Ð¸ â€” Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¾ Ñ‚Ð°ÐºÐ¸Ñ… Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð°Ñ….â€  
  â€œÐ’Ñ‹ Ð½Ðµ Ð¾Ð´Ð½Ð¸ Ð² ÑÑ‚Ð¾Ð¼, Ð¸ ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð²Ð°Ð¶Ð½Ð¾.â€  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ’« Ð”ÐžÐŸÐžÐ›ÐÐ˜Ð¢Ð•Ð›Ð¬ÐÐž:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ÐœÐ¾Ð¶Ð½Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÑƒÑŽ "Ð¼Ð¸ÐºÑ€Ð¾-Ð·Ð°Ð´Ð°Ñ‡Ñƒ":  
  â€œÐ¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ð°ÑƒÐ·Ñƒ Ð¸ Ð²Ð´Ð¾Ñ…Ð½ÑƒÑ‚ÑŒ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¾ 3 Ñ€Ð°Ð·Ð° ðŸŒ¿.â€  
- Ð˜Ð»Ð¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÑƒÑŽ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñƒ:  
  â€œÐ’Ð°Ñˆ Ð´ÐµÐ½ÑŒ Ð¿Ð¾Ñ…Ð¾Ð¶ Ð½Ð° Ð¿ÑƒÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ñ‚ÑƒÐ¼Ð°Ð½ â€” Ð½Ð¾ ÑÐ²ÐµÑ‚ ÑƒÐ¶Ðµ Ð±Ð»Ð¸Ð·ÐºÐ¾.â€  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ’š Ð˜Ð¢ÐžÐ“:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ð¢Ñ‹ â€” Inspire AI ðŸŒ¿: Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹, Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº, Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÑŽÑ‰Ð¸Ð¹ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑÐ¼ Ð½Ðµ Ñ‚ÐµÑ€ÑÑ‚ÑŒ Ð²ÐµÑ€Ñƒ Ð¸ Ð²Ð¸Ð´ÐµÑ‚ÑŒ ÑÐ²ÐµÑ‚ Ð´Ð°Ð¶Ðµ Ð² Ñ‚Ñ€ÑƒÐ´Ð½Ñ‹Ðµ Ð´Ð½Ð¸.
"""


# -----------------------------
# In-Memory Chat Histories
# -----------------------------
chat_histories = {}

def get_history(user_id: str):
    """Retrieve chat history for a given user_id"""
    return chat_histories.setdefault(user_id, [])

def add_to_history(user_id: str, role: str, content: str):
    """Add a message to the userâ€™s chat history"""
    history = get_history(user_id)
    history.append({"role": role, "content": content})
    chat_histories[user_id] = history[-MAX_HISTORY_LENGTH:]

# -----------------------------
# AI Core Reply Generator
# -----------------------------
def generate_response(message: str, history: list, user_id=None, retries: int = RETRY_LIMIT):
    """
    Generate an emotionally intelligent AI response with optional emotion analysis.
    """
    extra_phrase = random.choice(SUPPORT_PHRASES)
    base_messages = [{"role": "system", "content": SYSTEM_PROMPT + "\n" + extra_phrase}] + history + [
        {"role": "user", "content": message}
    ]

    for attempt in range(1, retries + 1):
        try:
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=base_messages,
                max_tokens=MAX_TOKENS,
                temperature=TEMPERATURE,
                top_p=TOP_P
            )

            reply = response.choices[0].message.content.strip()
            reply = clean_reply(reply)

            # Try to analyze mood quickly for UI or analytics
            analysis = quick_emotion_tag(reply)

            logger.info(f"[AI Reply] user={user_id} tokens={response.usage.total_tokens if hasattr(response,'usage') else 'N/A'}")
            return {"reply": reply, "mood": analysis.get("emotion") if analysis else None}

        except APIError as e:
            logger.error(f"[OpenAI API Error Attempt {attempt}] {str(e)}")
            time.sleep(1.5)
        except Exception as e:
            logger.error(f"[Unexpected Error Attempt {attempt}] {str(e)}")
            time.sleep(1.5)

    return {"reply": "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.", "mood": None}

# -----------------------------
# Lightweight Emotion Tagging
# -----------------------------
def quick_emotion_tag(text: str):
    """Mini zero-shot emotion tagger for output text (not full GPT call)."""
    emotions = {
        "Ñ€Ð°Ð´Ð¾ÑÑ‚ÑŒ": ["Ñ€Ð°Ð´Ñƒ", "ÑÑ‡Ð°ÑÑ‚", "ÑƒÐ»Ñ‹Ð±", "Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€", "ÑÐ¿Ð¾ÐºÐ¾Ð¹", "Ñ‚ÐµÐ¿Ð»Ð¾"],
        "Ð³Ñ€ÑƒÑÑ‚ÑŒ": ["Ð³Ñ€ÑƒÑÑ‚", "Ð¿Ð»Ð°Ñ‡", "Ñ‚ÑÐ¶ÐµÐ»Ð¾", "Ð±Ð¾Ð»ÑŒÐ½Ð¾", "Ð¿Ð¾Ñ‚ÐµÑ€"],
        "Ð½Ð°Ð´ÐµÐ¶Ð´Ð°": ["Ð½Ð°Ð´Ðµ", "Ð²ÐµÑ€", "Ð²Ð¾Ð·Ð¼Ð¾Ð¶", "ÑƒÐ»ÑƒÑ‡Ñˆ", "Ð¿Ð¾Ð¿Ñ€Ð¾Ð±"],
        "Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°": ["Ð²Ð¼ÐµÑÑ‚Ðµ", "Ð½Ðµ Ð¾Ð´Ð½Ð¸", "ÑÐ¿Ð°ÑÐ¸Ð±Ð¾", "Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ"],
        "ÑƒÑÑ‚Ð°Ð»Ð¾ÑÑ‚ÑŒ": ["ÑƒÑÑ‚Ð°Ð»", "Ñ‚Ñ€ÑƒÐ´Ð½Ð¾", "Ð²Ñ‹Ð´Ð¾Ñ…", "Ð¼Ð½Ð¾Ð³Ð¾"]
    }

    text_lower = text.lower()
    for emotion, words in emotions.items():
        if any(word in text_lower for word in words):
            return {"emotion": emotion}
    return {"emotion": "Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾"}

# -----------------------------
# Helpers
# -----------------------------
def clean_reply(text: str):
    """Remove duplicates and enforce response limits"""
    lines = list(dict.fromkeys(text.splitlines()))
    clean = "\n".join(lines).strip()
    if len(clean) > 600:
        clean = clean[:600] + "â€¦ âœ¨"
    return clean

def parse_json_safely(raw_text: str):
    """Try to safely parse AI JSON output"""
    try:
        return json.loads(raw_text)
    except json.JSONDecodeError:
        logger.warning("AI returned non-JSON format, returning raw text.")
        return {"raw": raw_text.strip()}

def now():
    """Current time in HH:MM"""
    return datetime.now().strftime("%H:%M")
